<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Document</title>
</head>
<body>
<p id="info"></p>
<canvas id="mycanvas"></canvas>
<script src="http://pixijs.download/release/pixi.js"></script>
<script>

const colors = [0xffffff, 0xfffff, 0xff0000];
const HUMAN = 1;
const AI = 2;

var Game = function() {
	var that = this;
	this.board = [];
	this.turn = 0;  // 0 for human, 1 for ai;
	this.init = function(){
	  for(var i = 0; i < 6; i++)
	  {
		this.board[i] = [];
		for(var j = 0; j < 7; j++)
		{
			this.board[i][j] = 0;
		}
	  }
	};

	this.handleAIMove = function(c){
		if(this.turn == 1){
			var random =Math.floor(Math.random()*this.getEmpty().length);
			this.handleMove(this.getEmpty()[random], AI);
		}
	}

	this.getEmpty = function(){
		var arr = [];
		for(var i = 0; i < 6; i++)
	  {
		for(var j = 0; j < 7; j++)
		{
			if(this.board[i][j] == 0){
				arr.push(j);
			}
		}
	  }
	  return arr;
	}

	this.handleMove = function(c, player){
		var r = 0;
		while(r < 6 && !this.isTaken(r, c)){
			r += 1;
		}
		if (r != 0) {
		   this.board[r-1][c] = player; 
		   this.turn = 1 - this.turn;
		}
		
		console.log("check");
		if(this.checkWin()){
			console.log("win");
			this.showInfo();
		}
	}

	this.showInfo = function(){
		var info = document.getElementById('info');
		if(this.winner == HUMAN){
		   info.innerHTML = "You win";
		} else {
			info.innerHTML = "You lose";
		}
		
	}

	this.isTaken = function(r, c){
		return this.board[r][c] == HUMAN || this.board[r][c] == AI;
	}

	this.winner = null;

	this.checkWin = function(){
		// horizontal
		for(var i = 0; i < 6; i++){
			for(var j = 0; j < 7 - 3; j++){
				if(this.board[i][j] != 0 && this.board[i][j] == this.board[i][j+1] &&
					this.board[i][j+1] == this.board[i][j+2] &&
					this.board[i][j+2] == this.board[i][j+3])
				{
					this.turn = -1;
					this.winner = this.board[i][j];
					return true;		
				}
			}
		}

		// vertical
		var j = 0;
		while(j < 7){
			for(var i = 0; i < 3; i++){
				if(this.board[i][j] != 0 && this.board[i][j] == this.board[i+1][j]
					&& this.board[i+1][j] == this.board[i+2][j]
					&& this.board[i+2][j] == this.board[i+3][j])
				{
					this.turn = -1;
					this.winner = this.board[i][j];
					return true;
				}
			}
			j += 1;
		}

		// diagonal
		for(var i = 0; i < 3; i++){
			for(var j = 0; j < 4; j++){
				if(this.board[i][j] != 0 && 
					this.board[i][j] == this.board[i+1][j+1] &&
					this.board[i+1][j+1] == this.board[i+2][j+2]
					&& this.board[i+3][j+3]){
					this.turn = -1;
			     	this.winner = this.board[i][j];
				    return true;
				}
			}
		}
		for(var i = 0; i < 3; i++){
			for(var j = 6; j > 2; j--){
				if(this.board[i][j] != 0 &&
					this.board[i][j] == this.board[i+1][j-1]
					&& this.board[i+1][j-1] == this.board[i+2][j-2]
					&& this.board[i+2][j-2] == this.board[i+3][j-3]){
					this.turn = -1;
				    this.winner = this.board[i][j];
				    return true;
				}
			}
		}

	}

};


var game = new Game();
game.init();
var board = game.board;

var renderer = PIXI.autoDetectRenderer(560, 540, false, true);

//Add the canvas to the HTML document
document.body.appendChild(renderer.view);
var stage = new PIXI.Container(0xFFFFFF);
function drawCircle(x, y, id, color){
	var graphics = new PIXI.Graphics();
	graphics.beginFill(color);
	
	graphics.drawCircle(x, y, 30);
	graphics.endFill();
	graphics.hitArea = new PIXI.Circle(x, y, 30);
	graphics.interactive = true;
	graphics.indexID = id;
	graphics.alpha = 1;
    stage.addChild(graphics);
    graphics.on('click', handleClick);
    graphics.on('mouseover', handleMouseOver);
    graphics.on('mouseout', handleMouseLeave);
}
drawBoard();

function handleClick(e){
	if(game.turn == 0){
		var graphics = e.target;
		var id = e.target.indexID;
		var i = id[0];
		var j = id[1];
		// var x = graphics.graphicsData[0].shape.x;
		// var y = graphics.graphicsData[0].shape.y;
		graphics.clear();
		game.handleMove(j, HUMAN);
		drawBoard();
		game.handleAIMove();
		drawBoard();
		console.log(e.target.indexID);
	}
}

function handleMouseOver(e){
	e.data.target.alpha = 0.5;
}

function handleMouseLeave(e){
	e.data.target.alpha = 1;
}

function drawBoard(){
   var y = 0;
   for(var i = 0; i < 6; i++){
    y += 80;
    var x = -40;
    for(var j = 0; j < 7; j++){
        x += 80;
        var id = [i, j];
        console.log(board[i][j]);
        drawCircle(x, y, id, colors[board[i][j]]);
    }
}
}






// run the render loop
animate();

function animate() {

    renderer.render(stage);
    requestAnimationFrame( animate );
}

</script>
	
</body>
</html>