<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Document</title>
</head>
<body>
<p id="info"></p>
<canvas id="mycanvas"></canvas>
<script src="http://pixijs.download/release/pixi.js"></script>
<script>

const colors = ['FFFFFF.png', 'grinning-face.png', 'dog-face.png'];
const HUMAN = 1;
const AI = 2;

var Game = function() {
	var that = this;
	this.board = [];
	this.turn = 0;  // 0 for human, 1 for ai;
	this.init = function(){
	  for(var i = 0; i < 6; i++)
	  {
		this.board[i] = [];
		for(var j = 0; j < 7; j++)
		{
			this.board[i][j] = 0;
		}
	  }
	};

	this.handleAIMove = function(c){
		if(this.turn == 1){
			var random =Math.floor(Math.random()*this.getEmpty().length);
			this.handleMove(this.getEmpty()[random], AI);
		}
	}

	this.getEmpty = function(){
		var arr = [];
		for(var i = 0; i < 6; i++)
	  {
		for(var j = 0; j < 7; j++)
		{
			if(this.board[i][j] == 0){
				arr.push(j);
			}
		}
	  }
	  return arr;
	}

	this.handleMove = function(c, player){
		var r = 0;
		while(r < 6 && !this.isTaken(r, c)){
			r += 1;
		}
		if (r != 0) {
		   this.board[r-1][c] = player; 
		   this.turn = 1 - this.turn;
		}
		
		
	}

	this.showInfo = function(){
		var info = document.getElementById('info');
		if(this.winner == HUMAN){
		   info.innerHTML = "You win";
		} else {
			info.innerHTML = "You lose";
		}
		
	}

	this.isTaken = function(r, c){
		return this.board[r][c] == HUMAN || this.board[r][c] == AI;
	}

	this.winner = null;

	this.checkWin = function(){
		// horizontal
		for(var i = 0; i < 6; i++){
			for(var j = 0; j < 7 - 3; j++){
				if(this.board[i][j] != 0 && this.board[i][j] == this.board[i][j+1] &&
					this.board[i][j+1] == this.board[i][j+2] &&
					this.board[i][j+2] == this.board[i][j+3])
				{
					this.turn = -1;
					this.winner = this.board[i][j];
					return true;		
				}
			}
		}

		// vertical
		var j = 0;
		while(j < 7){
			for(var i = 0; i < 3; i++){
				if(this.board[i][j] != 0 && this.board[i][j] == this.board[i+1][j]
					&& this.board[i+1][j] == this.board[i+2][j]
					&& this.board[i+2][j] == this.board[i+3][j])
				{
					this.turn = -1;
					this.winner = this.board[i][j];
					return true;
				}
			}
			j += 1;
		}

		// diagonal
		for(var i = 0; i < 3; i++){
			for(var j = 0; j < 4; j++){
				if(this.board[i][j] != 0 && 
					this.board[i][j] == this.board[i+1][j+1] &&
					this.board[i+1][j+1] == this.board[i+2][j+2]
					&& this.board[i+3][j+3]){
					this.turn = -1;
			     	this.winner = this.board[i][j];
				    return true;
				}
			}
		}
		for(var i = 0; i < 3; i++){
			for(var j = 6; j > 2; j--){
				if(this.board[i][j] != 0 &&
					this.board[i][j] == this.board[i+1][j-1]
					&& this.board[i+1][j-1] == this.board[i+2][j-2]
					&& this.board[i+2][j-2] == this.board[i+3][j-3]){
					this.turn = -1;
				    this.winner = this.board[i][j];
				    return true;
				}
			}
		}

	}

};


var game = new Game();
game.init();
var board = game.board;

var renderer = PIXI.autoDetectRenderer(562, 600, false, true);
renderer.backgroundColor = 0x1099bb;

//Add the canvas to the HTML document
document.body.appendChild(renderer.view);
var stage = new PIXI.Container(0xFFFFFF);

var style = {
    fontFamily : 'Arial',
    fontSize : '36px',
    fontStyle : 'italic',
    fontWeight : 'bold',
    fill : '#F7EDCA',
    stroke : '#4a1850',
    strokeThickness : 5,
    dropShadow : true,
    dropShadowColor : '#000000',
    dropShadowAngle : Math.PI / 6,
    dropShadowDistance : 6,
    wordWrap : true,
    wordWrapWidth : 440
};

var basicText = new PIXI.Text('CONNECT 4',style);
basicText.x = 150;
basicText.y = 40;

stage.addChild(basicText);


function drawCircle(x, y, id, sprite){
	var graphics = new PIXI.Graphics();
	graphics.beginFill(0xffffff);
	graphics.drawCircle(x, y, 30);
	graphics.endFill();
    stage.addChild(graphics);
    var dogface = PIXI.Sprite.fromImage(sprite);
    dogface.width = 60;
	dogface.height = 60;
	dogface.position.x = x-30;
	dogface.position.y = y-30;
	stage.addChild(dogface);
	dogface.mask = graphics;
	dogface.interactive = true;
	dogface.indexID = id;
    
    dogface.on('click', handleClick);
    dogface.on('mouseover', handleMouseOver);
    dogface.on('mouseout', handleMouseLeave);
}




drawBoard();

function getSprites(){
	var children = stage.children;
	var sprites = []
	for(var i = 2; i < children.length; i+=2){
		sprites.push(children[i]);
	}
	return sprites;
}

var children = stage.children;
console.log(children[2].position.x);
//children[2].anchor.x = 0.5
console.log(children[2].anchor.x)

function handleClick(e){

	if(game.turn == 0){
		var id = e.target.indexID;
		var i = id[0];
		var j = id[1];
		game.handleMove(j, HUMAN);
		drawBoard();
		game.handleAIMove();
		drawBoard();

		console.log("check");
		if(game.checkWin()){
			console.log("win");
			
		}	
	}
}

function handleMouseOver(e){
	var col = e.data.target.indexID[1];
	console.log(col);
	var sprites = getSprites();
	for(var i = 0; i < sprites.length; i++){
		if (i % 7 == col){
			sprites[i].alpha = 0.2;
		}
	}
}

function handleMouseLeave(e){
	var col = e.data.target.indexID[1];
	console.log(col);
	var sprites = getSprites();
	for(var i = 0; i < sprites.length; i++){
		if (i % 7 == col){
			sprites[i].alpha = 1;
		}
	}
}

function drawBoard(){
   var y = 80;
   for(var i = 0; i < 6; i++){
    y += 80;
    var x = -40;
    for(var j = 0; j < 7; j++){
        x += 80;
        var id = [i, j];
        drawCircle(x, y, id, colors[board[i][j]]);
    }
}
}

function drawSingle(row,col,color){
	y = 80 * (row+1);
	x = -40 + 80 * (col+1);
	
	drawCircle(x, y, [row, col],color);
}


function showWin(){
	basicText.text = "You Win!!!";
}

// run the render loop
animate();

function animate() {
	if(game.checkWin()){
		showWin();
	}
	
    renderer.render(stage);
    requestAnimationFrame( animate );
}


</script>
	
</body>
</html>