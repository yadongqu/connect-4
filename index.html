<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Document</title>
	<style>
	body{
		background-color: #4C4C4C;
		text-align: center;
		padding-top:50px;
		cursor: pointer;
	}
	</style>
</head>
<body>

<script src="http://pixijs.download/release/pixi.js"></script>
<script>

const colors = ['FFFFFF.png', 'grinning-face.png', 'dog-face.png'];
const HUMAN = 1;
const AI = 2;

var Game = function() {
	var that = this;
	this.board = [];
	this.score = 0;
	this.total = 0;
	this.count = 0;
	this.turn = 0;  // 0 for human, 1 for ai;
	this.init = function(){
	  for(var i = 0; i < 6; i++)
	  {
		this.board[i] = [];
		for(var j = 0; j < 7; j++)
		{
			this.board[i][j] = 0;
		}
	  }
	};

	this.setCount = function(){
		if(this.winner == HUMAN){
			this.count += 1;
			this.score = this.count * 100;
		}
		this.total += 1;
	}

	this.handleAIMove = function(c){
		if(this.turn == 1){
			var random =Math.floor(Math.random()*this.getEmpty().length);
			this.handleMove(this.getEmpty()[random], AI);
		}
	}

	this.getEmpty = function(){
		var arr = [];
		for(var i = 0; i < 6; i++)
	  {
		for(var j = 0; j < 7; j++)
		{
			if(this.board[i][j] == 0){
				arr.push(j);
			}
		}
	  }
	  return arr;
	}

	this.handleMove = function(c, player){
		var r = 0;
		while(r < 6 && !this.isTaken(r, c)){
			r += 1;
		}
		if (r != 0) {
		   this.board[r-1][c] = player; 
		   this.turn = 1 - this.turn;
		}
		if(r == 0){
			this.board[r][c] = player;
			this.turn = 1 - this.turn;
		}	
		
	}

	this.isTaken = function(r, c){
		return this.board[r][c] == HUMAN || this.board[r][c] == AI;
	}

	this.winner = null;

	this.checkWin = function(){
		// horizontal
		for(var i = 0; i < 6; i++){
			for(var j = 0; j < 7 - 3; j++){
				if(this.board[i][j] != 0 && this.board[i][j] == this.board[i][j+1] &&
					this.board[i][j+1] == this.board[i][j+2] &&
					this.board[i][j+2] == this.board[i][j+3])
				{
					this.turn = -1;
					this.winner = this.board[i][j];
					this.setCount();
					return true;		
				}
			}
		}

		// vertical
		var j = 0;
		while(j < 7){
			for(var i = 0; i < 3; i++){
				if(this.board[i][j] != 0 && this.board[i][j] == this.board[i+1][j]
					&& this.board[i+1][j] == this.board[i+2][j]
					&& this.board[i+2][j] == this.board[i+3][j])
				{
					this.turn = -1;
					this.winner = this.board[i][j];
					this.setCount();
					return true;
				}
			}
			j += 1;
		}

		// diagonal
		for(var i = 0; i < 3; i++){
			for(var j = 0; j < 4; j++){
				if(this.board[i][j] != 0 && 
					this.board[i][j] == this.board[i+1][j+1] &&
					this.board[i+1][j+1] == this.board[i+2][j+2]
					&& this.board[i+3][j+3]){
					this.turn = -1;
			     	this.winner = this.board[i][j];
			     	this.setCount();
				    return true;
				}
			}
		}
		for(var i = 0; i < 3; i++){
			for(var j = 6; j > 2; j--){
				if(this.board[i][j] != 0 &&
					this.board[i][j] == this.board[i+1][j-1]
					&& this.board[i+1][j-1] == this.board[i+2][j-2]
					&& this.board[i+2][j-2] == this.board[i+3][j-3]){
					this.turn = -1;
				    this.winner = this.board[i][j];
				    this.setCount();
				    return true;
				}
			}
		}

	}

};


var game = new Game();
game.init();
game.turn = -1;
var board = game.board;

var renderer = PIXI.autoDetectRenderer(600, 700,{"antialias": true});
renderer.backgroundColor = 0x1099bb;

renderer.view.style.borderRadius = "30px";
//Add the canvas to the HTML document
document.body.appendChild(renderer.view);
var stage = new PIXI.Container(0xFFFFFF);


function drawTitle(){
	var titleStyle = {
    fontFamily : 'Arial',
    fontSize : '36px',
    fontStyle : 'italic',
    fontWeight : 'bold',
    fill : '#F7EDCA',
    stroke : '#4a1850',
    strokeThickness : 5,
    dropShadow : true,
    dropShadowColor : '#000000',
    dropShadowAngle : Math.PI / 6,
    dropShadowDistance : 6,
    wordWrap : true,
    wordWrapWidth : 440
	};

	var basicText = new PIXI.Text('CONNECT 4',titleStyle);
	basicText.x = 180;
	basicText.y = 30;
	basicText.name = "title";
	stage.addChild(basicText);
}
drawTitle();



function drawButton(){
    var button = PIXI.Sprite.fromImage("startbutton.png");
    button.scale.set(0.5);
    button.x = 220;
    button.y = 90;
    button.interactive = true;
    button.on('mouseover',handleButtonMouseOver);
    button.on('mouseout',handleButtonMouseOut);
    button.on('click', handleButtonClick);
    stage.addChild(button);   
}

function handleButtonMouseOut(e){
	e.data.target.scale.set(0.5, 0.5);
}

function handleButtonMouseOver(e){
	e.data.target.scale.set(0.6, 0.6);
}


function handleButtonClick(e){
	e.target.scale.set(0.6, 0.6);
}


function drawScoreAndRound(){
	var score = new PIXI.Text('Score: ' + game.score);
	score.x = 40;
	score.y = 180;
	stage.addChild(score);

	var round = new PIXI.Text('Round: ' + game.total);
	round.x = 440;
	round.y = 180;
	stage.addChild(round);
}

drawScoreAndRound();



function drawCircle(x, y, id, sprite){
	var graphics = new PIXI.Graphics();
	graphics.beginFill(0xffffff);
	graphics.drawCircle(x, y, 30);
	graphics.endFill();
    stage.addChild(graphics);
    var player = PIXI.Sprite.fromImage(sprite);
    player.width = 60;
	player.height = 60;
	player.position.x = x-30;
	player.position.y = y-30;
	stage.addChild(player);
	player.mask = graphics;
	player.interactive = true;
	player.indexID = id;
    
    player.on('click', handleClick);
    player.on('mouseover', handleMouseOver);
    player.on('mouseout', handleMouseLeave);
}

drawBoard();

function getSprites(){
	var children = stage.children;
	var sprites = []
	for(var i = 2; i < children.length-1; i+=2){
		sprites.push(children[i]);
	}
	return sprites;
}



function handleClick(e){

	if(game.turn == 0){
		var id = e.target.indexID;
		var i = id[0];
		var j = id[1];
		game.handleMove(j, HUMAN);
		drawBoard();
		game.handleAIMove();
		drawBoard();

		console.log("check");
		if(game.checkWin()){
			console.log("win");
			
		}	
	}
}

function handleMouseOver(e){
	var col = e.data.target.indexID[1];
	console.log(col);
	var sprites = getSprites();
	for(var i = 0; i < sprites.length; i++){
		if (i % 7 == col){
			sprites[i].alpha = 0.2;
		}
	}
}

function handleMouseLeave(e){
	var col = e.data.target.indexID[1];
	console.log(col);
	var sprites = getSprites();
	for(var i = 0; i < sprites.length; i++){
		if (i % 7 == col){
			sprites[i].alpha = 1;
		}
	}
}

function drawBoard(){
   var y = 200;
   for(var i = 0; i < 6; i++){
    y += 70;
    var x = -20;
    for(var j = 0; j < 7; j++){
        x += 80;
        var id = [i, j];
        drawCircle(x, y, id, colors[board[i][j]]);
    }
}
}

function drawSingle(row,col,color){
	y = 80 * (row+1);
	x = -40 + 80 * (col+1);
	
	drawCircle(x, y, [row, col],color);
}


function showWin(){
	if(game.winner == HUMAN){
		stage.getChildAt(0).text = "You Win  !!!";
	} else {
		stage.getChildAt(0).text = "You were beated"
	}
	console.log(game.winner);
	
}

drawButton();
animate();

function animate() {
	if(game.checkWin()){
		showWin();
	}
	
    renderer.render(stage);
    requestAnimationFrame( animate );
}


</script>
	
</body>
</html>